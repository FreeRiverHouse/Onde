name: Site Health Check

# DISABLED 2026-02-15: All runs failing due to GitHub Actions billing issue.
# Was running every 15 minutes and spamming failure emails.
# Re-enable once billing is fixed.
on:
  # schedule:
  #   # Run every 15 minutes
  #   - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Check Site Health
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check onde.la
        run: |
          status=$(curl -s -o /dev/null -w '%{http_code}' https://onde.la)
          if [ "$status" != "200" ]; then
            echo "::error::onde.la is DOWN! Status: $status"
            exit 1
          fi
          echo "‚úÖ onde.la is UP (HTTP $status)"
      
      - name: Check moonlight-house
        run: |
          status=$(curl -s -o /dev/null -w '%{http_code}' https://moonlight-house.pages.dev)
          if [ "$status" != "200" ]; then
            echo "::error::moonlight-house is DOWN! Status: $status"
            exit 1
          fi
          echo "‚úÖ moonlight-house is UP (HTTP $status)"
      
      - name: Check onde.surf
        run: |
          # onde.surf requires auth, so it MUST return 307 redirect to /login
          # If it returns 200, auth might be broken and dashboard is exposed!
          status=$(curl -s -o /dev/null -w '%{http_code}' https://onde.surf)
          if [ "$status" = "307" ]; then
            echo "‚úÖ onde.surf auth OK (HTTP 307 redirect to login)"
          elif [ "$status" = "200" ]; then
            echo "::warning::‚ö†Ô∏è onde.surf returned 200 - AUTH MIGHT BE BROKEN! Dashboard may be publicly exposed!"
          else
            echo "::error::onde.surf is DOWN! Status: $status"
            exit 1
          fi
      
      - name: Verify onde.la content
        run: |
          content=$(curl -s https://onde.la)
          if ! echo "$content" | grep -q "Onde"; then
            echo "::error::onde.la content check failed - 'Onde' not found!"
            exit 1
          fi
          echo "‚úÖ onde.la content verified"

      - name: Alert on failure
        if: failure()
        run: |
          echo "üö® SITE DOWN ALERT - Check GitHub Actions for details"
          # Could add webhook/notification here
