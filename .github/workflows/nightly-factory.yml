# Nightly Factory - Produzione automatica contenuti
# Gira ogni notte alle 2:00 AM PT e risveglia gli agenti

name: Nightly Factory

on:
  schedule:
    # Ogni notte alle 2:00 AM Pacific Time (10:00 UTC)
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task specifico da eseguire'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - generate-audio
          - translate
          - prepare-assets

jobs:
  wake-agents:
    runs-on: ubuntu-latest
    name: Risveglia Agenti

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: ./scripts/factory
        continue-on-error: true

      - name: Check pending tasks
        id: check-tasks
        run: |
          echo "Checking for pending tasks..."
          # Legge la queue dei task pendenti
          if [ -f "queue/pending-tasks.json" ]; then
            echo "tasks_found=true" >> $GITHUB_OUTPUT
            cat queue/pending-tasks.json
          else
            echo "tasks_found=false" >> $GITHUB_OUTPUT
            echo "No pending tasks found"
          fi

      - name: Generate Audio (ElevenLabs)
        if: github.event.inputs.task == 'all' || github.event.inputs.task == 'generate-audio'
        run: |
          echo "Generating audio content..."
          node scripts/factory/generate-audio.js || echo "Audio script not found yet"
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}

      - name: Translate Content (Claude API)
        if: github.event.inputs.task == 'all' || github.event.inputs.task == 'translate'
        run: |
          echo "Translating content..."
          node scripts/factory/translate-content.js || echo "Translation script not found yet"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Prepare Video Assets
        if: github.event.inputs.task == 'all' || github.event.inputs.task == 'prepare-assets'
        run: |
          echo "Preparing video assets..."
          node scripts/factory/prepare-assets.js || echo "Assets script not found yet"

      - name: Notify Telegram
        if: always()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Nightly Factory Report</b>%0A%0AStatus: ${{ job.status }}%0ATime: $(date)%0A%0AControlla GitHub per i dettagli."
        continue-on-error: true

  create-daily-summary:
    runs-on: ubuntu-latest
    name: Crea Summary Giornaliero
    needs: wake-agents
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create summary issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Factory Summary - ${date}`,
              body: `## Nightly Factory Run - ${date}

### Status
- Wake Agents: ${{ needs.wake-agents.result }}

### Tasks Completed
- [ ] Audio generation
- [ ] Translation
- [ ] Asset preparation

### Ready for Approval
Check the \`output/\` folder for content ready to be reviewed.

### Next Steps
1. Review generated content
2. Approve via Telegram/Dashboard
3. Publish

---
*Automatically generated by Nightly Factory*`,
              labels: ['factory', 'daily-summary', 'automation']
            });
