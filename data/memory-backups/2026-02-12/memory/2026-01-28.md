# 2026-01-28 Session Notes

## Onde.la Deploy
- **Fixed deploy pipeline** - Cloudflare API token added to `.env`
- Token: `CLOUDFLARE_API_TOKEN` in project `.env`
- Script `./tools/tech-support/deploy-onde-la-prod.sh` now works
- **Issue:** Playwright not installed for automated tests - Claude Code fixing it
- **Workaround:** Direct wrangler deploy works with token set

## Moonlight House Upgrade ðŸŽ®
Major gameplay features added:
- ðŸ† **Achievement system** (7 achievements: Explorer, First Meal, Sleepy Head, Socialite, Shopper, Wealthy, Healthy)
- ðŸŒ™ **Day/Night cycle** - visual overlay changes with real time
- ðŸ˜Š **Mood system** - Happy, Sad, Sleepy, Hungry, Excited based on stats
- ðŸŽ **Daily rewards** - bonus coins + streak multiplier
- âš¡ **Random events** - visitors, gifts, rain (every 30s, 10% chance)
- ðŸŽ® **Mini-game** - "Star Catch" in garden (20% chance when playing)
- ðŸ“Š **XP/Level progression** - actions give XP, level up rewards

## UI Components Added
- shadcn/ui style components in `apps/onde-portal/src/components/ui/`
- Button, Card, Badge, Spotlight, Aurora effects
- Added Spotlight + Aurora to homepage hero section

## Trading
- Autotrader running (PID 62163)
- 04:00 UTC series: 5 trades, 53 contracts NO â†’ WIN (BTC stayed above $88,250-$88,500)
- Estimated profit: ~$52.27
- Autotrader continuing on 05:00 UTC series

## Key Learnings
- Wrangler needs `CLOUDFLARE_API_TOKEN` env var for non-interactive deploys
- My exec commands don't inherit shell env vars - need inline export
- Playwright Python module needed for test scripts (pip install playwright)

## GitHub Billing
- Deploy workflow failed due to billing/spending limit issue
- User needs to check: https://github.com/settings/billing

## Autotrader Fix (13:50 PST)
**Problem**: 0% win rate on 41 trades - all NO bets during BTC rally ($88kâ†’$90k)

**Root cause**: Old model had bearish bias
- Assumed 55% probability BTC stays BELOW strike
- Didn't account for momentum or proper volatility scaling
- Cheap NO bets looked like "45% edge" but were actually traps

**Fix applied**:
1. Black-Scholes inspired probability model with z-score
2. Momentum tracking (4h price trend)
3. Higher minimum edge (25%) for NO bets
4. Proper volatility scaling with sqrt(time)

**Result**: Now finds balanced opportunities, found YES bet instead of NO trap

## 15:10 - Heartbeat: Homepage Fix & Deploy

**Issue Found:** onde.la homepage returning 404. Tests failing, deploy blocked.

**Root Cause:** Stray `apps/onde-portal/app/` directory (with only icons) was created during favicon work. Next.js prefers `app/` over `src/app/`, so the empty app folder broke routing.

**Fix:** Moved icons from `app/` to `src/app/`, removed the stray directory. Committed, pushed, deployed.

**Result:** 
- onde.la homepage now returns 200 OK
- Build + tests pass
- Deployed to Cloudflare Pages

**Tasks Completed:** T200, T204

## 16:27 - ETH Support Added to Autotrader [T223]

**Implementation:**
- Modified `kalshi-autotrader-v2.py` to scan BOTH BTC (KXBTCD) and ETH (KXETHD) markets
- Added `get_crypto_ohlc(coin_id)` - generic OHLC fetcher for any CoinGecko coin
- Wrapped it with `get_btc_ohlc()` and `get_eth_ohlc()` for backwards compat
- Uses separate volatility constants: BTC 0.5%, ETH 0.7% hourly
- Separate momentum tracking for each asset
- Trade log now includes `asset` field
- `find_opportunities()` now takes `prices` dict and `momentum_data` dict

**Result:**
- Now scanning 100 total markets (50 BTC + 50 ETH)
- Shows prices for both: `BTC: $88,945 | ETH: $3,002`
- Separate momentum display for each asset
- ETH opportunities appearing in skip summary

**New Tasks Added:**
- T235: ETH settlement tracker support
- T236: Per-asset win rate tracking
- T237: Auto-rebalance between assets based on volatility

**Commit:** c1e16c49e

## 21:15 - Heartbeat Tasks

**T352 - Removed branding from onde.la (DONE)**
- Removed "made with love" from hero subtitle in page.tsx
- Removed "âš¡ Powered by Vercel" from footer in ClientLayout.tsx
- Deployed to onde.la via Cloudflare Pages
- Cleaner branding, no external attributions

**T371 - Dark mode toggle for trading dashboard (DONE)**
- Added Sun/Moon/Monitor icons import
- Added toggle button in header (cycles: dark â†’ light â†’ system)
- Made container background theme-responsive
- Made animated background blobs theme-aware (softer in light mode)
- Made grid overlay adjust for light/dark
- 'T' keyboard shortcut already documented
- Persists via ThemeProvider localStorage

**New Tasks Added:** T369-T371 (volatility analysis, memory age check, dark mode)

## Heartbeat ~12:30 PST - Autotrader Improvements

Completed 3 tasks during this heartbeat cycle:

### T294: Alert on extreme volatility entry âœ…
- Added 5-tier volatility classification (very_low/low/normal/high/very_high)
- New `check_extreme_vol_alert()` triggered when trading during >2% hourly range
- Alert file: kalshi-extreme-vol.alert with full trade details
- 1h cooldown between alerts

### T301: Alert when momentum aligns across all timeframes âœ…
- New `check_momentum_alignment_alert()` for high-conviction signals
- Triggers when all timeframes (1h/4h/24h) agree with strength >0.5
- Alert file: kalshi-momentum-aligned.alert
- 2h cooldown (rare event)

### T395: Log full momentum alignment in trade data âœ…
- Added `full_alignment` field to opportunity data + trade_log
- Captures when all timeframes agree regardless of direction
- Enables future analysis of alignment effectiveness

### Added 3 new tasks:
- T393: Whipsaw detection (momentum flip twice in same day)
- T394: Analyze win rate by momentum alignment status
- T395: Log momentum alignment status in trade data (completed)

Autotrader running (PID 7498), no alerts pending.
