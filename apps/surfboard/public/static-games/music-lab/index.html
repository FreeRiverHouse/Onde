<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <title>Music Lab - Onde Kids</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #2d1b69, #11998e);
      color: white; overflow-x: hidden;
    }

    .container {
      max-width: 700px; margin: 0 auto; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
    }

    h1 { font-size: 2.4em; margin: 15px 0 5px; }
    .subtitle { color: rgba(255,255,255,0.7); margin-bottom: 15px; }

    .tabs {
      display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;
    }
    .tab {
      padding: 8px 18px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7);
      font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 0.9em;
    }
    .tab:hover { background: rgba(255,255,255,0.1); }
    .tab.active { border-color: #00d2ff; background: rgba(0,210,255,0.15); color: white; }

    .card {
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px; padding: 25px; width: 100%;
      backdrop-filter: blur(10px); margin-bottom: 15px;
    }

    /* PIANO */
    .piano-container { position: relative; display: flex; justify-content: center; margin: 15px 0; overflow-x: auto; }
    .piano {
      display: flex; position: relative; height: 180px;
    }
    .white-key {
      width: 48px; height: 180px; background: linear-gradient(180deg, #f8f8f8, #e8e8e8);
      border: 1px solid #ccc; border-radius: 0 0 8px 8px;
      cursor: pointer; transition: all 0.1s; position: relative; z-index: 1;
      display: flex; align-items: flex-end; justify-content: center;
      padding-bottom: 10px; font-size: 0.75em; color: #666; font-weight: 600;
    }
    .white-key:hover { background: linear-gradient(180deg, #fff, #f0f0f0); }
    .white-key:active, .white-key.active {
      background: linear-gradient(180deg, #e0f0ff, #b0d4f1);
      transform: scaleY(0.98); transform-origin: top;
    }
    .black-key {
      width: 30px; height: 115px;
      background: linear-gradient(180deg, #333, #111);
      border-radius: 0 0 5px 5px; cursor: pointer;
      position: absolute; z-index: 2;
      transition: all 0.1s;
    }
    .black-key:hover { background: linear-gradient(180deg, #444, #222); }
    .black-key:active, .black-key.active {
      background: linear-gradient(180deg, #555, #333);
      height: 112px;
    }

    .note-label {
      text-align: center; margin-top: 10px; font-size: 1.8em; font-weight: 800;
      min-height: 50px; color: #00d2ff;
    }

    /* SEQUENCER */
    .sequencer-grid {
      display: grid; gap: 3px; margin: 15px 0;
    }
    .seq-cell {
      width: 100%; aspect-ratio: 1; border-radius: 6px;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer; transition: all 0.15s;
    }
    .seq-cell:hover { background: rgba(255,255,255,0.15); }
    .seq-cell.active { border-color: rgba(0,210,255,0.6); }
    .seq-cell.playing { box-shadow: 0 0 10px rgba(0,210,255,0.5); transform: scale(1.05); }

    .seq-controls {
      display: flex; gap: 10px; justify-content: center; align-items: center;
      margin: 10px 0; flex-wrap: wrap;
    }
    .seq-btn {
      padding: 10px 22px; border-radius: 14px; border: none;
      background: rgba(255,255,255,0.1); color: white; font-weight: 700;
      cursor: pointer; transition: all 0.2s; font-size: 1em;
    }
    .seq-btn:hover { background: rgba(255,255,255,0.2); }
    .seq-btn.playing { background: rgba(231,76,60,0.3); border: 1px solid #e74c3c; }
    .tempo-display { font-size: 0.9em; color: rgba(255,255,255,0.6); }

    /* EAR TRAINING */
    .ear-card { text-align: center; }
    .play-sound-btn {
      padding: 20px 35px; border-radius: 50%; border: 3px solid rgba(0,210,255,0.4);
      background: rgba(0,210,255,0.15); color: #00d2ff; font-size: 2.5em;
      cursor: pointer; transition: all 0.3s; margin: 15px 0;
    }
    .play-sound-btn:hover { transform: scale(1.1); background: rgba(0,210,255,0.25); }
    .play-sound-btn:active { transform: scale(0.95); }

    .interval-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
    .interval-btn {
      padding: 12px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06); color: white; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .interval-btn:hover { background: rgba(255,255,255,0.12); }
    .interval-btn.correct { border-color: #2ecc71; background: rgba(46,204,113,0.2); }
    .interval-btn.wrong { border-color: #e74c3c; background: rgba(231,76,60,0.2); }

    .ear-stats { display: flex; gap: 15px; justify-content: center; margin: 10px 0; }
    .ear-stat { text-align: center; }

    .section { display: none; }
    .section.active { display: block; }

    .back-link { display: inline-block; margin-top: 15px; color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.9em; }
    .back-link:hover { color: white; }

    .note-colors {
      display: flex; gap: 4px; justify-content: center; margin: 10px 0; flex-wrap: wrap;
    }
    .note-color {
      width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 0.65em; font-weight: 800; color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Music Lab</h1>
    <p class="subtitle">Play, create & train your ears!</p>

    <div class="tabs">
      <button class="tab active" onclick="showSection('piano')">üéπ Piano</button>
      <button class="tab" onclick="showSection('sequencer')">üéõÔ∏è Beat Maker</button>
      <button class="tab" onclick="showSection('ear')">üëÇ Ear Training</button>
    </div>

    <!-- PIANO SECTION -->
    <div id="section-piano" class="section active" style="width:100%;">
      <div class="card">
        <div class="note-colors" id="note-colors"></div>
        <div class="piano-container">
          <div class="piano" id="piano"></div>
        </div>
        <div class="note-label" id="note-label">üéµ Press a key!</div>
        <p style="color: rgba(255,255,255,0.4); font-size: 0.85em; text-align:center; margin-top: 8px;">
          Use keyboard keys A-K for white notes, W-U for sharps!
        </p>
      </div>
    </div>

    <!-- SEQUENCER SECTION -->
    <div id="section-sequencer" class="section" style="width:100%;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <span style="font-weight:700;">üéõÔ∏è Beat Grid</span>
          <div class="seq-controls">
            <button class="seq-btn" id="play-btn" onclick="togglePlay()">‚ñ∂Ô∏è Play</button>
            <button class="seq-btn" onclick="clearGrid()">üóëÔ∏è Clear</button>
            <button class="seq-btn" onclick="randomBeat()">üé≤ Random</button>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <span style="font-size:0.8em; color:rgba(255,255,255,0.5);">Tempo:</span>
          <input type="range" min="60" max="200" value="120" id="tempo-slider" oninput="updateTempo()" style="flex:1;"/>
          <span class="tempo-display" id="tempo-display">120 BPM</span>
        </div>
        <div style="display:flex; gap:3px; align-items:start;">
          <div style="display:flex; flex-direction:column; gap:3px; padding-top:2px;">
            <div style="height:28px; display:flex; align-items:center; font-size:0.7em; color:rgba(255,255,255,0.5);">ü•Å</div>
            <div style="height:28px; display:flex; align-items:center; font-size:0.7em; color:rgba(255,255,255,0.5);">üëè</div>
            <div style="height:28px; display:flex; align-items:center; font-size:0.7em; color:rgba(255,255,255,0.5);">üîî</div>
            <div style="height:28px; display:flex; align-items:center; font-size:0.7em; color:rgba(255,255,255,0.5);">üéµ</div>
          </div>
          <div class="sequencer-grid" id="seq-grid" style="flex:1; grid-template-columns: repeat(8, 1fr);"></div>
        </div>
        <div style="display:flex; gap:5px; margin-top:10px; justify-content:center;">
          <button class="seq-btn" style="font-size:0.8em; padding:6px 14px;" onclick="setPreset('rock')">üé∏ Rock</button>
          <button class="seq-btn" style="font-size:0.8em; padding:6px 14px;" onclick="setPreset('hiphop')">üé§ Hip Hop</button>
          <button class="seq-btn" style="font-size:0.8em; padding:6px 14px;" onclick="setPreset('latin')">üíÉ Latin</button>
          <button class="seq-btn" style="font-size:0.8em; padding:6px 14px;" onclick="setPreset('techno')">ü§ñ Techno</button>
        </div>
      </div>
    </div>

    <!-- EAR TRAINING SECTION -->
    <div id="section-ear" class="section" style="width:100%;">
      <div class="card ear-card">
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 10px;">Listen to two notes and identify the interval!</p>
        <div class="ear-stats">
          <div class="ear-stat"><div style="font-size:0.7em; color:rgba(255,255,255,0.5);">Score</div><div style="font-weight:800; color:#ffd200;" id="ear-score">0</div></div>
          <div class="ear-stat"><div style="font-size:0.7em; color:rgba(255,255,255,0.5);">Correct</div><div style="font-weight:800; color:#2ecc71;" id="ear-correct">0/0</div></div>
        </div>
        <button class="play-sound-btn" id="ear-play-btn" onclick="playInterval()">üîä</button>
        <p style="font-size:0.85em; color:rgba(255,255,255,0.5);" id="ear-instruction">Tap to hear the interval</p>
        <div class="interval-options" id="interval-options"></div>
        <div style="min-height:30px; font-weight:700; margin:5px 0;" id="ear-feedback">&nbsp;</div>
      </div>
    </div>

    <a href="/games" class="back-link">‚Üê Back to Games</a>
  </div>

  <script>
    // Audio context
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    // Note frequencies (C4 to C5)
    const notes = [
      { name: 'C', freq: 261.63, color: '#e74c3c' },
      { name: 'C#', freq: 277.18, color: '#333' },
      { name: 'D', freq: 293.66, color: '#e67e22' },
      { name: 'D#', freq: 311.13, color: '#333' },
      { name: 'E', freq: 329.63, color: '#f1c40f' },
      { name: 'F', freq: 349.23, color: '#2ecc71' },
      { name: 'F#', freq: 369.99, color: '#333' },
      { name: 'G', freq: 392.00, color: '#3498db' },
      { name: 'G#', freq: 415.30, color: '#333' },
      { name: 'A', freq: 440.00, color: '#9b59b6' },
      { name: 'A#', freq: 466.16, color: '#333' },
      { name: 'B', freq: 493.88, color: '#e91e63' },
      { name: 'C5', freq: 523.25, color: '#e74c3c' },
    ];

    function playNote(freq, duration = 0.4, type = 'triangle') {
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + duration);
    }

    // ============ PIANO ============
    function buildPiano() {
      const piano = document.getElementById('piano');
      piano.innerHTML = '';

      const whiteNotes = [0,2,4,5,7,9,11,12]; // C,D,E,F,G,A,B,C5
      const blackNotes = [
        { idx: 1, offset: 0 }, // C#
        { idx: 3, offset: 1 }, // D#
        { idx: 6, offset: 3 }, // F#
        { idx: 8, offset: 4 }, // G#
        { idx: 10, offset: 5 }, // A#
      ];

      const keyMap = ['a','s','d','f','g','h','j','k']; // white keys
      const blackKeyMap = ['w','e','','t','y','u']; // black keys

      whiteNotes.forEach((noteIdx, i) => {
        const key = document.createElement('div');
        key.className = 'white-key';
        key.dataset.note = noteIdx;
        key.innerHTML = `<span>${notes[noteIdx].name}</span>`;
        key.onmousedown = () => { playPianoNote(noteIdx); key.classList.add('active'); };
        key.onmouseup = () => key.classList.remove('active');
        key.onmouseleave = () => key.classList.remove('active');
        key.ontouchstart = (e) => { e.preventDefault(); playPianoNote(noteIdx); key.classList.add('active'); };
        key.ontouchend = () => key.classList.remove('active');
        piano.appendChild(key);
      });

      // Black keys
      blackNotes.forEach((bn) => {
        const key = document.createElement('div');
        key.className = 'black-key';
        key.dataset.note = bn.idx;
        key.style.left = (bn.offset * 48 + 33) + 'px';
        key.onmousedown = () => { playPianoNote(bn.idx); key.classList.add('active'); };
        key.onmouseup = () => key.classList.remove('active');
        key.onmouseleave = () => key.classList.remove('active');
        key.ontouchstart = (e) => { e.preventDefault(); playPianoNote(bn.idx); key.classList.add('active'); };
        key.ontouchend = () => key.classList.remove('active');
        piano.appendChild(key);
      });

      // Note colors
      const colorsEl = document.getElementById('note-colors');
      colorsEl.innerHTML = notes.filter(n => !n.name.includes('#')).map(n =>
        `<div class="note-color" style="background:${n.color};">${n.name.replace('5','')}</div>`
      ).join('');

      // Keyboard listener
      document.addEventListener('keydown', (e) => {
        if (document.getElementById('section-piano').className.indexOf('active') < 0) return;
        const whiteIdx = keyMap.indexOf(e.key.toLowerCase());
        if (whiteIdx >= 0) playPianoNote(whiteNotes[whiteIdx]);
        const blackIdx = blackKeyMap.indexOf(e.key.toLowerCase());
        if (blackIdx >= 0 && blackNotes[blackIdx]) playPianoNote(blackNotes[blackIdx].idx);
      });
    }

    function playPianoNote(idx) {
      const note = notes[idx];
      playNote(note.freq, 0.6);
      const label = document.getElementById('note-label');
      label.textContent = `üéµ ${note.name} (${Math.round(note.freq)} Hz)`;
      label.style.color = note.color;
    }

    // ============ SEQUENCER ============
    const ROWS = 4;
    const COLS = 8;
    let grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(false));
    let isPlaying = false;
    let currentCol = 0;
    let playInterval = null;
    let tempo = 120;

    const rowSounds = [
      { freq: 150, type: 'square', dur: 0.1 },   // kick
      { freq: 800, type: 'square', dur: 0.05 },   // clap
      { freq: 1200, type: 'sine', dur: 0.15 },    // bell
      { freq: 440, type: 'triangle', dur: 0.2 },  // note
    ];

    const rowColors = ['#e74c3c', '#f1c40f', '#3498db', '#2ecc71'];

    function buildGrid() {
      const gridEl = document.getElementById('seq-grid');
      gridEl.innerHTML = '';
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const cell = document.createElement('div');
          cell.className = 'seq-cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.id = `cell-${r}-${c}`;
          cell.onclick = () => toggleCell(r, c);
          gridEl.appendChild(cell);
        }
      }
      renderGrid();
    }

    function toggleCell(r, c) {
      grid[r][c] = !grid[r][c];
      renderGrid();
      if (grid[r][c]) {
        const s = rowSounds[r];
        playNote(s.freq, s.dur, s.type);
      }
    }

    function renderGrid() {
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const cell = document.getElementById(`cell-${r}-${c}`);
          cell.classList.toggle('active', grid[r][c]);
          cell.style.background = grid[r][c] ? rowColors[r] + '40' : '';
          cell.style.borderColor = grid[r][c] ? rowColors[r] : '';
          cell.classList.remove('playing');
        }
      }
    }

    function togglePlay() {
      if (isPlaying) {
        stopPlay();
      } else {
        isPlaying = true;
        currentCol = 0;
        document.getElementById('play-btn').textContent = '‚èπÔ∏è Stop';
        document.getElementById('play-btn').classList.add('playing');
        playStep();
        playInterval = setInterval(playStep, (60 / tempo) * 1000 / 2);
      }
    }

    function stopPlay() {
      isPlaying = false;
      clearInterval(playInterval);
      document.getElementById('play-btn').textContent = '‚ñ∂Ô∏è Play';
      document.getElementById('play-btn').classList.remove('playing');
      renderGrid();
    }

    function playStep() {
      // Remove previous column highlight
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          document.getElementById(`cell-${r}-${c}`).classList.remove('playing');
        }
      }

      // Highlight and play current column
      for (let r = 0; r < ROWS; r++) {
        const cell = document.getElementById(`cell-${r}-${currentCol}`);
        cell.classList.add('playing');
        if (grid[r][currentCol]) {
          const s = rowSounds[r];
          playNote(s.freq, s.dur, s.type);
        }
      }

      currentCol = (currentCol + 1) % COLS;
    }

    function clearGrid() {
      grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(false));
      renderGrid();
    }

    function randomBeat() {
      grid = Array(ROWS).fill(null).map(() =>
        Array(COLS).fill(false).map(() => Math.random() < 0.3)
      );
      renderGrid();
    }

    function updateTempo() {
      tempo = parseInt(document.getElementById('tempo-slider').value);
      document.getElementById('tempo-display').textContent = tempo + ' BPM';
      if (isPlaying) {
        clearInterval(playInterval);
        playInterval = setInterval(playStep, (60 / tempo) * 1000 / 2);
      }
    }

    const presets = {
      rock: [[1,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0],[1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0]],
      hiphop: [[1,0,0,1,0,0,1,0],[0,0,1,0,0,0,1,0],[1,1,0,0,1,1,0,0],[0,0,0,1,0,0,0,1]],
      latin: [[1,0,0,1,0,0,1,0],[0,0,1,0,1,0,0,1],[1,0,1,0,1,0,1,0],[0,1,0,0,0,1,0,0]],
      techno: [[1,0,1,0,1,0,1,0],[0,0,1,0,0,0,1,0],[1,1,1,1,1,1,1,1],[0,0,0,0,1,0,0,0]],
    };

    function setPreset(name) {
      grid = presets[name].map(r => r.map(v => !!v));
      renderGrid();
    }

    // ============ EAR TRAINING ============
    const intervals = [
      { name: 'Unison', semitones: 0 },
      { name: 'Minor 2nd', semitones: 1 },
      { name: 'Major 2nd', semitones: 2 },
      { name: 'Minor 3rd', semitones: 3 },
      { name: 'Major 3rd', semitones: 4 },
      { name: 'Perfect 4th', semitones: 5 },
      { name: 'Perfect 5th', semitones: 7 },
      { name: 'Octave', semitones: 12 },
    ];

    let earScore = 0, earTotal = 0, earCorrectCount = 0;
    let currentInterval = null;
    let baseFreq = 261.63;

    function playIntervalSound(semitones) {
      const ctx = getAudioCtx();
      const freq2 = baseFreq * Math.pow(2, semitones / 12);
      playNote(baseFreq, 0.5);
      setTimeout(() => playNote(freq2, 0.5), 600);
    }

    function setupEarRound() {
      // Pick 4 random intervals including the correct one
      const correct = intervals[Math.floor(Math.random() * intervals.length)];
      currentInterval = correct;
      baseFreq = 220 + Math.random() * 200; // Random base note

      let options = [correct];
      while (options.length < 4) {
        const pick = intervals[Math.floor(Math.random() * intervals.length)];
        if (!options.find(o => o.name === pick.name)) options.push(pick);
      }
      options.sort(() => Math.random() - 0.5);

      const optEl = document.getElementById('interval-options');
      optEl.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'interval-btn';
        btn.textContent = opt.name;
        btn.onclick = () => checkInterval(opt, btn);
        optEl.appendChild(btn);
      });

      document.getElementById('ear-feedback').innerHTML = '&nbsp;';
      document.getElementById('ear-instruction').textContent = 'Tap üîä to hear, then guess!';
    }

    function playInterval() {
      if (!currentInterval) setupEarRound();
      playIntervalSound(currentInterval.semitones);
    }

    function checkInterval(selected, btn) {
      document.querySelectorAll('.interval-btn').forEach(b => b.disabled = true);
      earTotal++;
      const fb = document.getElementById('ear-feedback');

      if (selected.name === currentInterval.name) {
        earCorrectCount++;
        earScore += 10;
        btn.classList.add('correct');
        fb.innerHTML = `<span style="color:#2ecc71">‚úÖ ${currentInterval.name}! Well done!</span>`;
      } else {
        btn.classList.add('wrong');
        document.querySelectorAll('.interval-btn').forEach(b => {
          if (b.textContent === currentInterval.name) b.classList.add('correct');
        });
        fb.innerHTML = `<span style="color:#e74c3c">‚ùå It was ${currentInterval.name}</span>`;
      }

      document.getElementById('ear-score').textContent = earScore;
      document.getElementById('ear-correct').textContent = `${earCorrectCount}/${earTotal}`;

      setTimeout(() => {
        currentInterval = null;
        setupEarRound();
      }, 1800);
    }

    // ============ SECTION SWITCHING ============
    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`section-${name}`).classList.add('active');
      event.currentTarget.classList.add('active');
      if (isPlaying && name !== 'sequencer') stopPlay();
    }

    // Init
    buildPiano();
    buildGrid();
    setupEarRound();
  </script>
</body>
</html>
