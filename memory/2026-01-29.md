# Memory - 2026-01-29

## T407 Fix: onde.surf agents not taking tasks

### Problem
When tasks were created via onde.surf FreeRiverHouse UI, agents weren't processing them.

### Root Cause Analysis
1. **Middleware blocking API**: `/api/agent-executor` was being redirected to `/login` because it wasn't in `publicRoutes`
2. **Wrong import**: `agent-executor/route.ts` used `getCloudflareContext` from `@opennextjs/cloudflare` instead of `getRequestContext` from `@cloudflare/next-on-pages` (which is what all other API routes use)

### Solution
1. Added agent APIs to `publicRoutes` in `middleware.ts`:
   - `/api/agent-executor` 
   - `/api/agent-tasks`
   - `/api/house`
   - `/api/activity`
   - `/api/agents`

2. Fixed import in `agent-executor/route.ts` to use `@cloudflare/next-on-pages`

3. Created `scripts/trigger-onde-surf-executor.sh` for automated triggering

4. Added cron job: `*/5 * * * * /Users/mattia/Projects/Onde/scripts/trigger-onde-surf-executor.sh`

### Manual Action Required
⚠️ **ANTHROPIC_API_KEY** needs to be set in Cloudflare Pages:
- Go to: Cloudflare Dashboard → Pages → onde-surf → Settings → Environment Variables
- Add: `ANTHROPIC_API_KEY` as encrypted secret
- Redeploy for changes to take effect

### New Tasks Added
- T647: Add "Run Executor" button to FreeRiverHouse UI
- T648: Configure ANTHROPIC_API_KEY in Cloudflare Pages (P1 manual task)
- T649: Agent heartbeat registration for onde.surf

### Architecture Note
onde.surf uses:
- **D1 Database** for task storage
- **Claude API directly** (not Clawdbot) for task execution
- **Edge runtime** (Cloudflare Workers/Pages)

This is SEPARATE from Clawdbot sessions running locally. To bridge them, agents would need to:
1. Poll D1 for tasks (pull model)
2. Or have onde.surf call Clawdbot gateway (push model)
3. Or register heartbeats to onde.surf D1 (T649)
